# 中斷與例外處理

## 簡介

中斷（interrupts）有兩種來源：由硬體產生的和由軟體產生的。通常，在硬體週邊設備需要 CPU 時（例如，要跟 CPU 要資料，或是有資料要給 CPU），會對 CPU 發出中斷要求。軟體也可以利用 INT n 指令來對 CPU 發出中斷要求。

例外（exceptions）分為三種：程式錯誤例外、軟體產生例外、和機器錯誤例外。程式錯誤例外是在處理器偵測到程式有不合法的行為，或是作業系統發生某些錯誤時，由處理器自動發出的例外。這種例外又可分為三種：faults、traps、和 aborts。

軟體產生的例外，是由 INTO、INT3、和 BOUND 指令產生的。例如，INT3 命令會發出一個「程式中斷點」的例外。用 INT n 指令也可以「模擬」例外，但是，例外發生時，處理器會把錯誤碼推入堆疊中，而 INT n 指令則不會。所以，如果直接使用 INT n 指令呼叫例外處理程序，則該程序會從堆疊中取出錯誤碼，而在返回時，會回到錯誤的位址。

在 Pentium 以後的處理器，可以檢查其內部是否有錯誤。在處理器有錯誤時，會產生機器錯誤例外。

中斷向量

中斷和例外是利用一個數字來區分不同的中斷或例外，這個數字稱為「中斷向量」（interrupt vector）。中斷向量是一個由 00H 到 FFH 的數字。其中，00H 到 1FH 的中斷向量是保留作系統用途的，不可任意使用；而其它的中斷向量則可以自由使用。保留的中斷向量如下表所示：

| 向量編碼    | 助憶碼 | 說明   | 型態         | 錯誤碼 | 來源                       |
| ------- | --- | ---- | ---------- | --- | ------------------------ |
| 00h     | #DE | 除法錯誤 | Fault      | 無   | DIV 和 IDIV 指令。           |
| 01h     | #DB | 除錯   | Fault/Trap | 無   | 任何對程式或資料的參考、或是 INT 1 指令。 |
| 02h     |     |      |            |     |                          |
| 03h     |     |      |            |     |                          |
| 04h     |     |      |            |     |                          |
| 05h     |     |      |            |     |                          |
| 06h     |     |      |            |     |                          |
| 07h     |     |      |            |     |                          |
| 08h     |     |      |            |     |                          |
| 09h     |     |      |            |     |                          |
| 0Ah     |     |      |            |     |                          |
| 0Bh     |     |      |            |     |                          |
| 0Ch     |     |      |            |     |                          |
| 0Dh     |     |      |            |     |                          |
| 0Eh     |     |      |            |     |                          |
| 0Fh     |     |      |            |     |                          |
| 10h     |     |      |            |     |                          |
| 11h     |     |      |            |     |                          |
| 12h     |     |      |            |     |                          |
| 13\~1Fh |     |      |            |     |                          |
| 20\~FFh |     |      |            |     |                          |



例外的型態


程式錯誤例外有三種：

Fault：這種例外通常是可以更正的，而且在更正後，程式應該可以繼續無誤地進行。在發生 fault 時，處理器會回到造成 fault 指令之前的狀況。在堆疊中存放的返回位址，存放的是造成 fault 的指令的位址。所以，在例外處理完，返回原程式時，會重新執行原來造成 fault 的指令。正常的話，應該不會再產生 fault。例如，最常見的 fault 應該是分頁錯誤（Page-fault），分頁錯誤的處理程序應該要讀入所需要的分頁，再返回程式中，讓程式可以繼續執行。

Trap：這種例外是在被 trap 的指令執行完後，立刻產生的。因此，它的返回位址是被 trap 的指令的下一個指令。在例外返回後，程式可以正確無誤地斷續執行。如果被 trap 的是一個跳躍指令（例如，JMP 指令）也不會有問題，它的返回位址會是 JMP 指令的目標。

Abort：這種例外是非常嚴重的錯誤，沒有辦法返回原程式繼續執行。通常，只有在機器錯誤、或是在系統表格中有不一致或不合法的數值時，才會出現這種例外。這類例外的處理程序，應該是把錯誤發生時的狀態存下，並儘可能安全地關閉應用程式和系統。

因為在中斷或（有些）例外發生時，原程式必須能繼續執行，因此，中斷和例外一定是在指令和指令中間發生，而不會在指令進行的途中發生。

[https://www.csie.ntu.edu.tw/\~wcchen/asm98/asm/proj/b85506061/chap4/overview.html](https://www.csie.ntu.edu.tw/\~wcchen/asm98/asm/proj/b85506061/chap4/overview.html)

