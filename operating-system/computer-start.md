# 開機流程

## 前置知識

學習計算機啟動過程的前置知識是什麼呢？需要已知以下幾點：

* 記憶體是存儲資料的地方，給出一個位址信號，記憶體可以返回該位址所對應的資料。
* CPU 的工作方式就是不斷從記憶體中取出指令並且執行。
* CPU 從記憶體的哪個位址取出指令，是由一個暫存器中的值決定的，這個值會不斷進行 +1 操作\(下一個指令或位元\)，或者由某條跳轉指令指定其值是多少。

## 我們按下開機鍵後究竟發生了什麼？

開機後有四次關鍵跳躍\(jmp\)指令，都是當時 Intel 和 BIOS 等製作廠商的固定下來的流程，記住就好。開機的時候CPU處於真實模式，可定址範圍為1M：

1. 按下開機鍵，CPU 將 PC 暫存器的值強制初始化為 0xFFFF0，這個位置是 BIOS 程式的入口位址（第一次跳躍）   。
2. 該入口位址處是一個跳轉指令，跳轉到 0xFE05B 位置，開始執行（第二次跳躍）   。
3. 執行了一些硬體檢測工作後，最後一步將啟動區內容加載（復制）到記憶體 0x7C00，並跳轉到這裡（第三次跳躍）。
4. 啟動區代碼主要是加載作業系統內核，並跳轉到加載處（第四次跳躍）。

## 記憶體對映\(memory mapping\)

CPU 位址匯流排的寬度決定了可訪問的記憶體空間的大小。

* 比如 16 位的 CPU 位址總線寬度為 20 條，可定址位址范圍是 $$2^{20} = 1 \ MB$$ 。
* 32 位的 CPU 位址總線寬度為 32 位，位址范圍是 $$2^{20} = 4\ GB$$ 。

可存取的記憶體空間這麼大，並不等於說全都給記憶體使用，也就是說定址的物件不只有記憶體，還有一些外圓設備也要通過位址匯流排的方式去存取。

那怎麼去存取這些外部設備呢？就是在位址范圍中劃出一片片的區域，這塊給視訊記憶體使用，那塊給硬碟控制器使用。我們在相應的位置上讀取或者寫入記憶體，就相當於在視訊記憶體等外設的相應位置上讀取或者寫入，就好像這些外設的儲存區域，被對映到了記憶體中的某一片區域一樣。這樣我們就不用管那些外設啦，關注點仍然是一個簡簡單單的記憶體。這就是所謂的**記憶體對映**。

真實模式時，記憶體的配置如下圖：

![&#x771F;&#x5BE6;&#x6A21;&#x5F0F;&#x8A18;&#x61B6;&#x9AD4;&#x914D;&#x7F6E;](../.gitbook/assets/real_mode_memory_allocation-min.png)

記憶體被各種外部設備對映在了記憶體中。BIOS不但其空間被對映到了記憶體 0xC0000 - 0xFFFFF 位置，其裡面的程式還佔用了開頭的一些區域，比如把中斷向量表寫在了記憶體開始的位置。

## BIOS 第一個被執行的部份

目前已經知道 BIOS 裡的資訊被對映到了記憶體 0xC0000 - 0xFFFFF 位置，其中最為關鍵的系統 BIOS 被對映到了 0xF0000 - 0xFFFFF \(16 Bytes\) 位置。

按下開機鍵，CPU 將 PC 暫存器的值強制初始化為 0xFFFF0，這個位址。更詳細的說，CPU 將段基址暫存器 CS 初始化為 0xF000，將偏移位址暫存器 IP 初始化為 0xFFF0，根據真實模式下的最終位址計算規則，將段基址左移 4 位，加上偏移位址，得到最終的實體位址也就是抽象出來的 PC 暫存器位址為 0xFFFF0。

0xF0000 - 0xFFFFF 只有16位元組，其中儲存的機器指令轉成組合語言是：

```erlang
JMP FAR F000:E05B ; 跳轉到實體位址 0xFE05B 處開始執行
```

位址 0xFE05B 處開始，便是 BIOS 真正發揮作用的程式碼了，這塊程式碼會檢測一些外部設備資訊，並初始化好硬體，建立中斷向量表並填寫中斷例程。這裡的部分不要展開，這只是一段寫死的程式而已，而且對理解開機啟動過程無幫助，後面精彩的部分是 BIOS 的最後一項工作：**載入啟動區**。



